http:
  port: 8080

apiEndpoints:
  # public endpoints (no auth required)
  public:
    host: "*"
    paths:
      - "/health"
      - "/api/public/*"
    methods: ["GET"]

  # protected endpoints - Service A (require API key)
  serviceA:
    host: "*"
    paths: "/api/service-a/*"
    methods: ["GET", "POST", "PUT", "DELETE"]

  # protected endpoints - Service B (require API key)
  serviceB:
    host: "*"
    paths: "/api/service-b/*"
    methods: ["GET", "POST", "PUT", "DELETE"]

  # premium endpoints (higher rate limit)
  premium:
    host: "*"
    paths: "/api/premium/*"
    methods: ["GET", "POST"]

serviceEndpoints:
  # backend Service A
  serviceABackend:
    url: "http://service-a:3001"

  # backend Service B
  serviceBBackend:
    url: "http://service-b:3002"

policies:
  - basic-auth
  - cors
  - expression
  - key-auth
  - log
  - oauth2
  - proxy
  - rate-limit
  - request-transformer
  - response-transformer

pipelines:
  # public pipeline (no auth, basic rate limit)
  publicPipeline:
    apiEndpoints:
      - public
    policies:
      - cors:
          - action:
              origin: "*"
              credentials: true
      - rate-limit:
          - action:
              max: 10
              windowMs: 60000 # 10 requests per minute
              rateLimitBy: "${req.ip}"
      - log:
          - action:
              message: "Public request: ${req.method} ${req.url} from ${req.ip}"
      - expression:
          - action:
              jscode: |
                if (req.path === '/health') {
                  res.json({ 
                    status: 'Gateway is running', 
                    timestamp: new Date().toISOString(),
                    redis: 'connected'
                  });
                } else {
                  res.json({ 
                    message: 'Public API endpoint',
                    info: 'No authentication required'
                  });
                }

  # service A pipeline (requires API key, standard rate limit)
  serviceAPipeline:
    apiEndpoints:
      - serviceA
    policies:
      - cors:
          - action:
              origin: "*"
              credentials: true
      # API key authentication
      - key-auth:
          - action:
              apiKeyHeader: "X-API-Key"
              apiKeyHeaderScheme: "ApiKey"
      # rate limiting per API key
      - rate-limit:
          - action:
              max: 100
              windowMs: 60000 # 100 requests per minute
              rateLimitBy: "${req.user.id}"
              headers: true
      # add user info to request headers
      - request-transformer:
          - action:
              headers:
                add:
                  X-Consumer-ID: "${req.user.id}"
                  X-Consumer-Username: "${req.user.username}"
      - log:
          - action:
              message: "Service A request: ${req.method} ${req.url} by user ${req.user.username}"
      - proxy:
          - action:
              serviceEndpoint: serviceABackend
              changeOrigin: true
              stripPath: true

  # service B pipeline (requires API key, standard rate limit)
  serviceBPipeline:
    apiEndpoints:
      - serviceB
    policies:
      - cors:
          - action:
              origin: "*"
              credentials: true
      # API key authentication
      - key-auth:
          - action:
              apiKeyHeader: "X-API-Key"
              apiKeyHeaderScheme: "ApiKey"
      # rate limiting per API key
      - rate-limit:
          - action:
              max: 100
              windowMs: 60000 # 100 requests per minute
              rateLimitBy: "${req.user.id}"
              headers: true
      # add user info to request headers
      - request-transformer:
          - action:
              headers:
                add:
                  X-Consumer-ID: "${req.user.id}"
                  X-Consumer-Username: "${req.user.username}"
      - log:
          - action:
              message: "Service B request: ${req.method} ${req.url} by user ${req.user.username}"
      - proxy:
          - action:
              serviceEndpoint: serviceBBackend
              changeOrigin: true
              stripPath: true

  # premium pipeline (requires API key, higher rate limit)
  premiumPipeline:
    apiEndpoints:
      - premium
    policies:
      - cors:
          - action:
              origin: "*"
              credentials: true
      # API key authentication
      - key-auth:
          - action:
              apiKeyHeader: "X-API-Key"
              apiKeyHeaderScheme: "ApiKey"
      # rate limiting per API key
      - rate-limit:
          - action:
              max: 500
              windowMs: 60000 # 500 requests per minute
              rateLimitBy: "${req.user.id}"
              headers: true
      # add user info to request headers
      - request-transformer:
          - action:
              headers:
                add:
                  X-Consumer-ID: "${req.user.id}"
                  X-Consumer-Username: "${req.user.username}"
                  X-Tier: "premium"
      - log:
          - action:
              message: "Premium request: ${req.method} ${req.url} by user ${req.user.username}"
      # route to Service A for demo
      - proxy:
          - action:
              serviceEndpoint: serviceABackend
              changeOrigin: true
